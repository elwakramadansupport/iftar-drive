// Sample Google Apps Script code
const sheetId = 'YOUR_GOOGLE_SHEET_ID'; // ID of the Google Sheet
const consumerKey = 'YOUR_CONSUMER_KEY';
const consumerSecret = 'YOUR_CONSUMER_SECRET';
const passkey = 'YOUR_LIPA_NA_MPESA_PASSKEY'; // From Daraja portal
const shortcode = '4341738'; // Your till number

function doGet(e) {
  const sheet = SpreadsheetApp.openById(sheetId).getActiveSheet();
  if (e.parameter.action === 'status') {
    const ref = e.parameter.ref;
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][2] === ref) { // Column C: Ref
        return ContentService.createTextOutput(JSON.stringify({ok: true, status: data[i][5]})) // Column F: Status
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    return ContentService.createTextOutput(JSON.stringify({ok: false, error: 'Not found'}))
      .setMimeType(ContentService.MimeType.JSON);
  } else {
    // Existing stats logic
    const data = sheet.getDataRange().getValues();
    let total = 0;
    let count = 0;
    for (let i = 1; i < data.length; i++) {
      if (data[i][5] === 'paid') { // Status
        total += Number(data[i][1]); // Amount
        count++;
      }
    }
    return ContentService.createTextOutput(JSON.stringify({ok: true, total, count}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  const sheet = SpreadsheetApp.openById(sheetId).getActiveSheet();
  let params = e.parameter;
  let postData = JSON.parse(e.postData.contents || '{}');
  
  if (params.action === 'callback') {
    // Handle M-Pesa callback
    const callbackData = postData.Body.stkCallback;
    const checkoutRequestID = callbackData.CheckoutRequestID;
    const resultCode = callbackData.ResultCode;
    
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][4] === checkoutRequestID) { // Column E: RequestID
        sheet.getRange(i+1, 6).setValue(resultCode === 0 ? 'paid' : 'failed'); // Column F: Status
        break;
      }
    }
    return ContentService.createTextOutput('{"ResultCode":0,"ResultDesc":"Accepted"}')
      .setMimeType(ContentService.MimeType.JSON);
  } else if (postData.action === 'initiate') {
    // Initiate STK Push
    try {
      const accessToken = getAccessToken();
      const timestamp = Utilities.formatDate(new Date(), "GMT+3", "yyyyMMddHHmmss");
      const password = Utilities.base64Encode(shortcode + passkey + timestamp);
      
      const payload = {
        "BusinessShortCode": shortcode,
        "Password": password,
        "Timestamp": timestamp,
        "TransactionType": "CustomerBuyGoodsOnline",
        "Amount": postData.amount,
        "PartyA": postData.phone,
        "PartyB": shortcode,
        "PhoneNumber": postData.phone,
        "CallBackURL": ScriptApp.getService().getUrl() + '?action=callback',
        "AccountReference": postData.ref,
        "TransactionDesc": "Ramadan Iftar Drive Donation"
      };
      
      const options = {
        method: 'post',
        contentType: 'application/json',
        headers: { 'Authorization': 'Bearer ' + accessToken },
        payload: JSON.stringify(payload)
      };
      
      const response = UrlFetchApp.fetch('https://api.safaricom.co.ke/mpesa/stkpush/v1/processrequest', options); // Use sandbox for testing: https://sandbox.safaricom.co.ke/...
      const responseData = JSON.parse(response.getContentText());
      
      if (responseData.ResponseCode === '0') {
        // Append to sheet: Timestamp, Amount, Ref, Phone, CheckoutRequestID, Status
        sheet.appendRow([
          new Date(),
          postData.amount,
          postData.ref,
          postData.phone,
          responseData.CheckoutRequestID,
          'pending'
        ]);
        
        return ContentService.createTextOutput(JSON.stringify({ok: true}))
          .setMimeType(ContentService.MimeType.JSON);
      } else {
        return ContentService.createTextOutput(JSON.stringify({ok: false, error: responseData.errorMessage}))
          .setMimeType(ContentService.MimeType.JSON);
      }
    } catch (error) {
      return ContentService.createTextOutput(JSON.stringify({ok: false, error: error.message}))
        .setMimeType(ContentService.MimeType.JSON);
    }
  } else {
    // Existing manual participation logic (optional, can remove if fully automating)
    sheet.appendRow([new Date(), postData.amount, postData.ref]);
    return ContentService.createTextOutput(JSON.stringify({ok: true}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function getAccessToken() {
  const auth = Utilities.base64Encode(consumerKey + ':' + consumerSecret);
  const options = {
    method: 'get',
    headers: { 'Authorization': 'Basic ' + auth }
  };
  const response = UrlFetchApp.fetch('https://api.safaricom.co.ke/oauth/v1/generate?grant_type=client_credentials', options); // sandbox: https://sandbox...
  return JSON.parse(response.getContentText()).access_token;
}
